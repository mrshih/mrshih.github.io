
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>MR SHIH</title>
  <meta name="author" content="施安宏">

  
  <meta name="description" content="Qucik Sort概念 第一次看到快速排序的許多介紹，可能第一時間腦袋轉不太過來，因為網路介紹常常把虛擬碼翻成步驟，直接敘述，所以腦袋普通像我就會沒辦法意會為什麼要做這個動作。比如後面會提到的In-Place版本交換這個動作就常常不知為何而做。這裡有個影片是從很高層次想法上去解釋Quick &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sah.tw">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="MR SHIH" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31868165-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">MR SHIH</a></h1>
  
    <h2>必幸施</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sah.tw" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/09/objc-quick-sort/">QuickSort與Obj-C</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-11-09T10:24:20+08:00" pubdate data-updated="true">Nov 9<sup>th</sup>, 2016</time>
        
           | <a href="/blog/2016/11/09/objc-quick-sort/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/11/09/objc-quick-sort/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Qucik Sort概念</h2>

<p>第一次看到快速排序的許多介紹，可能第一時間腦袋轉不太過來，因為網路介紹常常把虛擬碼翻成步驟，直接敘述，所以腦袋普通像我就會沒辦法意會為什麼要做這個動作。比如後面會提到的In-Place版本交換這個動作就常常不知為何而做。這裡有個<a href="https://www.youtube.com/watch?v=aQiWF4E8flQ">影片</a>是從很高層次想法上去解釋Quick Sort，個人看了之後再想想虛擬碼，也就豁然開朗了。</p>

<h2>Qucik Sort概念轉換成Code</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (NSArray *)quickSortUseExtraMemoryWithData:(NSArray *)data {
</span><span class='line'>
</span><span class='line'>    if (data.count &lt;= 1) { // 到底部了, 不需要排序, 直接回傳
</span><span class='line'>        return data;
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    int random = arc4random() % data.count;  // 隨機取用某index當pivot，避免比如排序已經排好的陣列，每次都取index0，會造成時間複雜度O(N^2)，worst case
</span><span class='line'>    NSNumber *pivot = data[random];
</span><span class='line'>    
</span><span class='line'>    NSMutableArray *less = [[NSMutableArray alloc]init];
</span><span class='line'>    NSMutableArray *greater = [[NSMutableArray alloc]init];
</span><span class='line'>    
</span><span class='line'>    for (int i=1; i&lt;=data.count-1; i++ ) {
</span><span class='line'>        if ([(NSNumber *)data[i]floatValue] &gt;= [pivot floatValue]) {
</span><span class='line'>            [greater addObject:data[i]];
</span><span class='line'>        }else {
</span><span class='line'>            [less addObject:data[i]];
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    NSMutableArray *result = [[NSMutableArray alloc]init];
</span><span class='line'>    [result addObjectsFromArray:[self quickSortUseExtraMemoryWithData:less]];
</span><span class='line'>    [result addObject:pivot];
</span><span class='line'>    [result addObjectsFromArray:[self quickSortUseExtraMemoryWithData:greater]];
</span><span class='line'>    
</span><span class='line'>    return result;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>如果常寫有支援記憶體管理語言比如Java或ARC版Obj-C的人可能會直覺寫出這個版本，因為在這幾個語言裡其實常常不用太管記憶體使用量太多這個問題，除非是UIImage等大型物件沒有釋放，不然常常遇到比如NSArray分割其實也就是再開兩個NSArray去存就好了。</p>

<p>上面這個實作方法每次都新開NSArray去存放分割後的子Array，而Quick Sort比Merge Sort好的地方在於它可以改用稱作In-Place的方法，只在同一個陣列做交換，可以避免運用消耗多餘的記憶體空間，參考文獻也寫說實務上也可以增加演算法的效率。</p>

<h2>Qucik Sort In-Place 版本</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (NSMutableArray *)quickSortInPlaceWithData:(NSMutableArray &lt;NSNumber *&gt;*)data leftIndex:(NSInteger)left rightIndex:(NSInteger)right{
</span><span class='line'>    // 使用in-place法，操作同一個陣列，避免額外消耗多餘記憶體，硬體限制嚴格的環境下使用
</span><span class='line'>    
</span><span class='line'>    if (left &gt; right) { // 底部。代表上一層遞迴切出來，這個sub-array已經只有一個元素，就不用排列了，'這個元素也會是已經就定位的'。
</span><span class='line'>        return nil;
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    NSNumber *pivot = data[right];
</span><span class='line'>    
</span><span class='line'>    NSInteger processIndexAKAWall = left;
</span><span class='line'>    [data exchangeObjectAtIndex:right withObjectAtIndex:right];// 把pivot移到最後面
</span><span class='line'>    for (int i=(int)left; i&lt;right; i++ ) { // left ... right-1
</span><span class='line'>        if ([data[i]floatValue] &lt; [pivot floatValue]) {
</span><span class='line'>            [data exchangeObjectAtIndex:processIndexAKAWall withObjectAtIndex:i];// 擺到牆的右邊
</span><span class='line'>            processIndexAKAWall = processIndexAKAWall + 1;// 牆往前
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    [data exchangeObjectAtIndex:processIndexAKAWall withObjectAtIndex:right];// 把pivot移到牆的右邊。這個pivot目前已經在正確的index上了。
</span><span class='line'>    
</span><span class='line'>    // 切兩段
</span><span class='line'>    // start by left, end by processIndexAKAWall - 1
</span><span class='line'>    // start by processIndexAKAWall + 1, end by right
</span><span class='line'>    [self quickSortInPlaceWithData:data leftIndex:left rightIndex:processIndexAKAWall - 1];
</span><span class='line'>    [self quickSortInPlaceWithData:data leftIndex:processIndexAKAWall + 1 rightIndex:right];
</span><span class='line'>    
</span><span class='line'>    return data;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/07/objc-merge-sort-category-oop/">MergeSort與Obj-C外加Category與OOP</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-11-07T00:18:53+08:00" pubdate data-updated="true">Nov 7<sup>th</sup>, 2016</time>
        
           | <a href="/blog/2016/11/07/objc-merge-sort-category-oop/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/11/07/objc-merge-sort-category-oop/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Merge Sort概念</h2>

<p>跟我一樣原本不知道Merge Sort是什麼碗糕的可以去這個<a href="https://www.youtube.com/watch?v=mzjjRPdH9Jw">影片</a>，這裡有可愛北一女的實際示範，中文的呦。如果英文好那我也是更推薦去看英文的，那資源又更多了。</p>

<h2>Merge Sort概念轉換成Code</h2>

<p>在懂了Merge Sort概念之後，如果對於如何把想法轉換成程式碼沒什麼感覺，可以看一段<a href="https://www.youtube.com/watch?v=es2T6KY45cA&amp;index=3&amp;list=PL2aHrV9pFqNRS2b2XX2BvgQIPKh72xREP">影片</a>，這段影片大概就是程式碼影片化後實際運作的樣子。</p>

<p>Merge Sort有分Recursive跟For loop兩種，但看完影片直覺就是用Recursive比較好做。這是因為你看Merge Sort其實是把一個大問題分成小問題，小問題再分成更小的問題，直到把問題切割成最小單元，再返回來把前一次的結果餵給上一層，之後一層一層的解回去。這是很典型的遞迴場景。</p>

<p>上面的問題解決思路在演算法裡面叫做Divide and Conquer，蠻傳神的解釋，把問題分解後在各個擊破。</p>

<h2>Objective-c Implement</h2>

<ul>
<li>Input為一個NSArray，裡面包含N個NSNumber，NSNumber可以為Int或Flot。</li>
<li>Output為一個把Input Array裡面的N個NSNumber由小排序到大的NSArray。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (NSArray *)mergeSortWithData:(NSArray *)data {
</span><span class='line'>    
</span><span class='line'>    if (data.count == 1) {
</span><span class='line'>        // div done here
</span><span class='line'>        // 這裡已經把問題分解成最小單位了，所以就告一段落
</span><span class='line'>        return data;
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    NSInteger divLength = data.count/2;
</span><span class='line'>    NSArray *left = [data subarrayWithRange:NSMakeRange(0, divLength)];
</span><span class='line'>    NSArray *rigth = [data subarrayWithRange:NSMakeRange(divLength, data.count-divLength)];
</span><span class='line'>    
</span><span class='line'>    NSArray&lt;NSNumber*&gt; *mergeArrayA = [self mergeSortWithData:left];
</span><span class='line'>    NSArray&lt;NSNumber*&gt; *mergeArrayB = [self mergeSortWithData:rigth];
</span><span class='line'>    
</span><span class='line'>    NSInteger headOfMergeArrayA = 0;
</span><span class='line'>    NSInteger headOfMergeArrayB = 0;
</span><span class='line'>    
</span><span class='line'>    NSMutableArray *resultArray = [[NSMutableArray alloc]initWithCapacity:mergeArrayA.count+mergeArrayB.count];
</span><span class='line'>    
</span><span class='line'>    Boolean control = true;
</span><span class='line'>    while (control) {
</span><span class='line'>        
</span><span class='line'>        if (headOfMergeArrayA == mergeArrayA.count) {
</span><span class='line'>            //MergeArrayA沒東西了
</span><span class='line'>            //把剩餘的MergeArrayB直接append到resultArray後面
</span><span class='line'>            [resultArray addObjectsFromArray:[mergeArrayB subarrayWithRange:NSMakeRange(headOfMergeArrayB, mergeArrayB.count-headOfMergeArrayB)]];
</span><span class='line'>            control = false;
</span><span class='line'>            break;
</span><span class='line'>        }else if(headOfMergeArrayB == mergeArrayB.count){
</span><span class='line'>            [resultArray addObjectsFromArray:[mergeArrayA subarrayWithRange:NSMakeRange(headOfMergeArrayA, mergeArrayA.count-headOfMergeArrayA)]];
</span><span class='line'>            control = false;
</span><span class='line'>            break;
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        if ([mergeArrayA[headOfMergeArrayA]floatValue] &gt; [mergeArrayB[headOfMergeArrayB]floatValue]) {
</span><span class='line'>            [resultArray addObject:mergeArrayB[headOfMergeArrayB]];
</span><span class='line'>            headOfMergeArrayB = headOfMergeArrayB + 1;
</span><span class='line'>        }else{
</span><span class='line'>            [resultArray addObject:mergeArrayA[headOfMergeArrayA]];
</span><span class='line'>            headOfMergeArrayA = headOfMergeArrayA + 1;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    return resultArray;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Do more &ndash; Free Function與Method</h2>

<p>可以看到<code>mergeSortWithData</code>是一個Function，但我自己Obj-C軟體實作的Coding style上如果一個Function的Input有指定要是某個Class，比如這裡就是指定<code>NSArray</code>，那這時候採用Method較好。</p>

<p>但通常很少情況會不指定Input的Clsas，所以實務上會盡量少用Free Function，附帶的好處是可以減少一堆Function散落在專案裡面，也可以盡量DRY（Don&rsquo;t repeat yourself）。</p>

<p>當然，不要過度強調DRY，因為這關係到切架構與抽象化整體的規劃能力，抽象的不好那是會用弄越糟的，但至少在這個簡單的Case裡Merge Sort做成Method絕對是make sense的。</p>

<p>這裡可以練習把Merge Sort用<code>Category</code>的方式做成<code>NSArray</code>的Method。基礎OOP，把一些地方改成<code>Self</code>就可以了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/24/iap-payment-model-design/">In-App-Purchase交易模組設計</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-08-24T23:30:18+08:00" pubdate data-updated="true">Aug 24<sup>th</sup>, 2016</time>
        
           | <a href="/blog/2016/08/24/iap-payment-model-design/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/08/24/iap-payment-model-design/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>網路上很多介紹如何運用<code>StoreKit</code>裡面的API在iOS上付款的文章，但實務上因為<code>In-App-Purchase</code>是程式裡面需要密集配合業務需求的部分，如果沒有一個良好抽象化的設計，在高可維護性與彈性，可擴展能力下功夫，一旦業務需求一複雜或反覆迭代更改，就會讓IAP相關的邏輯變得難以修改與維護。</p>

<p>以上原因，所以如何在APP中設計一套可維護可擴展易整合的IAP架構，是開發大型APP與進階開發者應該關心的議題。接下來的文章把IAP付款架構有關執行交易與交易結果處理的這部分，抽象成TNStoreObserver類別。</p>

<h2>StoreObserver</h2>

<p>付款流程是APP根據一組定義在iTunesConnect的商品ID，向Apple Server請求對應的<code>SKPayment</code>物件，裡面包含了Localization的商品名稱與價錢，把這個想成一個商品。而一旦把這個<code>SKPayment</code>物件放到由系統維護的<code>SKPaymentQueue</code>時，這時候就開始進入按指紋，輸入iTunes Store帳密的程序。</p>

<p>而<code>StoreKit</code>說明，當<code>SKPayment</code>加入到<code>SKPaymentQueue</code>後，開發者需要實作一個adopt<code>SKPaymentTransactionObserver</code>protocol的物件，並加入到<code>SKPaymentQueue</code>裡。之後這個Observer就是負責處理各種交易結果。比如成功時就要開啟對應的功能等。</p>

<p>所以這個Class就取名叫StoreObserver，職責是實作<code>SKPaymentTransactionObserver</code>protocol，處理交易完成的後續行為。並負責與<code>SKPaymentQueue</code>互動，比如購買，取回過去的購買紀錄。最後可方便的在任何地方發動購買，然後在需要的地方容易接收到結果。</p>

<p>基於以上需求，開去構思這個模組。</p>

<p>先處理交易的部分，這就是單純與StoreKit串接。以下兩個Public方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 購買SKProduct
</span><span class='line'>// Create and add a payment request to the payment queue
</span><span class='line'>-(void)buy:(SKProduct *)product
</span><span class='line'>{
</span><span class='line'>    SKMutablePayment *payment = [SKMutablePayment paymentWithProduct:product];
</span><span class='line'>  [[SKPaymentQueue defaultQueue] addPayment:payment];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// 取回過去完成交易的非消耗品購買與自動續訂紀錄
</span><span class='line'>-(void)restore
</span><span class='line'>{
</span><span class='line'>    [[SKPaymentQueue defaultQueue] restoreCompletedTransactions];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>實作上會把這個<code>StoreObserver</code>做成<code>Singleton</code>，因為APP裡面可能會有許多頁面允許付款，只要<code>[[StoreObserver sharedInstance] buy:product];</code>就可以購買商品。然後因應上面的<code>restore</code>方法，這裡需要一個<code>NSArray</code>來裝取回的商品們，命名為<code>productsRestored</code>。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (StoreObserver *)sharedInstance
</span><span class='line'>{
</span><span class='line'>    static dispatch_once_t onceToken;
</span><span class='line'>    static StoreObserver * storeObserverSharedInstance;
</span><span class='line'>    
</span><span class='line'>    dispatch_once(&onceToken, ^{
</span><span class='line'>        storeObserverSharedInstance = [[StoreObserver alloc] init];
</span><span class='line'>    });
</span><span class='line'>    return storeObserverSharedInstance;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>- (instancetype)init
</span><span class='line'>{
</span><span class='line'>  self = [super init];
</span><span class='line'>  if (self != nil)
</span><span class='line'>    {
</span><span class='line'>        _productsRestored = [[NSMutableArray alloc] initWithCapacity:0];
</span><span class='line'>    }
</span><span class='line'>  return self;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>這邊重要的來了，如果程式的某個地方呼叫了<code>StoreObserver</code>的<code>buy</code>發法，之後<code>StoreObserver</code>收到交易完成的資訊，而APP裡面可能會有很多地方因為這個交易而產生UI上的變化，比如買了一部影片，影片要開始播放，影片櫃需要新增新影片，會員的購買紀律需要增加一筆。該怎麼通知那麼多地方？這裡用了<code>NSNotificationCenter</code>。</p>

<p>為什麼呢？因為在上述一對多的狀況下，<code>StoreObserver</code>會被設計成它不關心那些畫面或地方需要這些訊息。但它會把資料準備好，接著廣播。</p>

<p>當通知的人不關心他會通知到誰，但可能需要被通知的人很多時，<code>NSNotificationCenter</code>機制就派上用場了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSString * const TNIAPPurchaseNotification = @"TNIAPPurchaseNotification";</span></code></pre></td></tr></table></div></figure>


<p>再來是讓接收廣播的地方容易做處理。在這個Class裡面我們設置三個Property，<code>status</code>，<code>message</code>和<code>purchasedID</code>。當這個Class實作<code>SKPaymentTransactionObserver</code>時，根據收到的資訊做整理，讓接收的人可以很方便利用交易結果。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef NS_ENUM(NSInteger, TNIAPPurchaseNotificationStatus)
</span><span class='line'>{
</span><span class='line'>    TNIAPPurchaseFailed, // Indicate that the purchase was unsuccessful
</span><span class='line'>    TNIAPPurchaseSucceeded, // Indicate that the purchase was successful
</span><span class='line'>    TNIAPRestoredFailed, // Indicate that restore products was unsuccessful
</span><span class='line'>    TNIAPRestoredSucceeded // Indicate that restore products was successful
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>@property (nonatomic) TNIAPPurchaseNotificationStatus status;
</span><span class='line'>@property (nonatomic, copy) NSString *purchasedID;
</span><span class='line'>@property (nonatomic, copy) NSString *message;</span></code></pre></td></tr></table></div></figure>


<p>比如當我們實作的<code>SKPaymentTransactionObserver</code>方法被<code>SKPaymentQueue</code>呼叫時，整理一下再POST Notification出去</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Called when an error occur while restoring purchases. Notify the user about the error.
</span><span class='line'>- (void)paymentQueue:(SKPaymentQueue *)queue restoreCompletedTransactionsFailedWithError:(NSError *)error
</span><span class='line'>{
</span><span class='line'>    if (error.code != SKErrorPaymentCancelled)
</span><span class='line'>    {
</span><span class='line'>        self.status = IAPRestoredFailed;
</span><span class='line'>        self.message = error.localizedDescription;
</span><span class='line'>        [[NSNotificationCenter defaultCenter] postNotificationName:TNIAPPurchaseNotification object:self];
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>實際運作</h2>

<p>這邊我們不考慮要怎麼取得到SKPayment物件，因為這部分邏輯不在<code>StoreObserver</code>負責範圍內。</p>

<h3>在任何地方容易的發動購買</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SKProduct *product = (SKProduct *)productRequestResponse[indexPath.row];
</span><span class='line'>        // Attempt to purchase the tapped product
</span><span class='line'>        [[TNStoreObserver sharedInstance] buy:product];</span></code></pre></td></tr></table></div></figure>


<h3>在需要的地方容易收到並做處理</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[[NSNotificationCenter defaultCenter] addObserver:self
</span><span class='line'>                                             selector:@selector(handlePurchasesNotification:)
</span><span class='line'>                                                 name:TNIAPPurchaseNotification
</span><span class='line'>                                               object:[StoreObserver sharedInstance]];
</span><span class='line'>
</span><span class='line'>// Update the UI according to the purchase request notification result
</span><span class='line'>-(void)handlePurchasesNotification:(NSNotification *)notification
</span><span class='line'>{
</span><span class='line'>    StoreObserver *purchasesNotification = (StoreObserver *)notification.object;
</span><span class='line'>    
</span><span class='line'>    IAPPurchaseNotificationStatus status = (IAPPurchaseNotificationStatus)purchasesNotification.status;
</span><span class='line'>    NSString *message = purchasesNotification.message;
</span><span class='line'>    NSString *purchasedID = purchasesNotification.purchasedID;
</span><span class='line'>   
</span><span class='line'>
</span><span class='line'>  switch (status)
</span><span class='line'>    {
</span><span class='line'>        case IAPPurchaseFailed:
</span><span class='line'>            //購買失敗...
</span><span class='line'>          break;
</span><span class='line'>            
</span><span class='line'>        case IAPDownloadSucceeded:
</span><span class='line'>        {
</span><span class='line'>            //購買成功...
</span><span class='line'>        }
</span><span class='line'>          break;
</span><span class='line'>        
</span><span class='line'>        case IAPRestoredSucceeded:
</span><span class='line'>        {
</span><span class='line'>            //回復成功...
</span><span class='line'>        }
</span><span class='line'>            break;
</span><span class='line'>            
</span><span class='line'>        case IAPRestoredFailed:
</span><span class='line'>            //回復失敗...
</span><span class='line'>            break;
</span><span class='line'>  } 
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/11/ios-view-advanced/">從零到穩固的基礎 - 談iOS刻畫UI</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-08-11T22:02:46+08:00" pubdate data-updated="true">Aug 11<sup>th</sup>, 2016</time>
        
           | <a href="/blog/2016/08/11/ios-view-advanced/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/08/11/ios-view-advanced/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MVVM是iOS開發近來熱門的開發架構，最近工作上不停用到這個架構去建立各種頁面，對於如何從零開始架構出一個方便開發與維護的MVVM架構有些實作上總結出的Tips或稱為想法在，這裡記錄下來與回顧。</p>

<p>系列第一篇會先從MVVM裡面的View開始講，通常這也是我開發的第一也是很重要的步驟，這裡一開始沒規劃好浪費的時間絕對是最多的，因為方向就錯了麻。</p>

<h2>看UI圖然後先想想</h2>

<p>第一步當然就是看著UI出好的圖，然後想想這個畫面上會用的什麼<code>UIKit</code>的控件。大部分不外乎是<code>TableView</code>, <code>CollectionView</code>, <code>PageView</code>，互相搭配即可組出框架。某些例外比如登入登出註冊頁面則通常就會一張空白<code>View</code>自己拉畫面，不太用到上面提到的控件。</p>

<p>真的有問題比如需要重新打造一個控件，或不好實作，卡到時間等，都在這裡即時反應給UI是最好的。不會先做下去遇到問題卡住再來溝通，這樣事倍功半真的也很浪費時間。</p>

<h2>先大致上命名好</h2>

<p>曾經有看過程式設計裡面在資深開發人員裡排名第一的難題是命名。這是因為如果一開始沒有想好階層式的命名方式，等到架構一大你就會開始需要在腦袋裡面Dump一堆記憶體來存這些Name的意義，久了也一定會忘記。</p>

<p>比如常見的新聞頁面</p>

<p><img src="http://sah.tw/images/2016-08-11-ios-view-advanced.png" alt="YahooNews" /></p>

<p>這個頁面大致需要下面幾個控件:</p>

<ol>
<li>主要<code>ViewController</code></li>
<li>一個<code>CollectionView</code>來當Indicator，顯示有那些類別</li>
<li>一個<code>PageController</code>來橫向翻頁在不同類別的新聞頁面</li>
<li>多個<code>TableView</code>拿來顯示新聞</li>
</ol>


<p>那在命名上就要先大致想好：</p>

<ol>
<li><code>SHReaderViewController</code></li>
<li><code>SHReaderCategoryIndicatorViewController</code> &ndash; <code>SHReaderCategoryIndicatorCell</code></li>
<li><code>SHReaderPageViewController</code></li>
<li><code>SHReaderNewsViewController</code> &ndash; <code>SHReaderNewsCell</code></li>
</ol>


<p>只要名字的Prefix按照大方向一樣，階層想好定下來後，不管是要新增Coustom Class，或是要在<code>Storyboard</code>上標註對應的<code>Storyboard Identifier</code>都很方便，之後再開發與維護上會因為也脈絡可循的命名而容易許多。</p>

<h2>多使用StackView</h2>

<p>在iOS9加入<code>StackView</code>之後，整個畫面裡面<code>Autolayout</code>所需要的<code>Constraints</code>大幅的減少很多，事實上官方也建議最好<code>Autolayout</code>任何畫面可以考慮直接用<code>StackView</code>開始。</p>

<p><code>StackView</code>的強項在於可以定義一個母區塊，讓裡面的<code>SubView</code>能Depend在母區塊的邊界上設定<code>Constraints</code>與做<code>Autolayout</code>，同時也限制這裡面的<code>StackView</code>裡的<code>SubView</code>改動不會影響到<code>StackView</code>之外的其他<code>View</code>。</p>

<p>在沒有<code>StackView</code>之前只有一個<code>RootView</code>要給整個畫面上一堆<code>SubView</code>當做參照，這樣在設計<code>Autolayout</code>上往往牽一髮動全身，一個<code>SubView</code>的更改常常就會連帶影響一大推其他的<code>View</code>。</p>

<h2>用Storyboard Reference切割不同功能的畫面</h2>

<p>比如<code>Tabbar</code>分出來的全部連到<code>Storyboard Reference</code>，或多次在不同地方會單獨<code>M  odel</code>出來的畫面要拆分出來。這樣一個團隊才可以同時協作開發多個頁面，解決了<code>Storyboard</code>一開始被大家詬病的<code>Git</code>協作問題。</p>

<h2>還有一些比較瑣碎的Tips</h2>

<h3>適時用Xib搭配Storyboard</h3>

<p>當我們有時候要自製一個小控件比如<code>Segment Control</code>，裡面的<code>Cell</code>便可以用xib。掌握住<code>initWithCoder</code>用來再<code>Storyboard</code>載入，比如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">//</span> <span class="no">If</span> <span class="n">you</span> <span class="n">are</span> <span class="n">loading</span> <span class="n">it</span> <span class="n">from</span> <span class="n">a</span> <span class="n">nib</span> <span class="n">file</span> <span class="p">(</span><span class="ow">or</span> <span class="n">a</span> <span class="n">storyboard</span><span class="p">),</span> <span class="ss">initWithCoder</span><span class="p">:</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="o">.</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="ss">initWithCoder</span><span class="p">:(</span><span class="no">NSCoder</span> <span class="o">*</span><span class="p">)</span><span class="n">aDecoder</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nb">self</span> <span class="o">=</span> <span class="o">[</span><span class="k">super</span> <span class="ss">initWithCoder</span><span class="p">:</span><span class="n">aDecoder</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">[</span><span class="nb">self</span> <span class="ss">addSubview</span><span class="p">:</span><span class="o">[[[</span><span class="no">NSBundle</span> <span class="n">mainBundle</span><span class="o">]</span> <span class="ss">loadNibNamed</span><span class="p">:</span><span class="no">NSStringFromClass</span><span class="p">(</span><span class="o">[</span><span class="nb">self</span> <span class="n">class</span><span class="o">]</span><span class="p">)</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span><span class="o">]</span> <span class="ss">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="o">]]</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>initWithFrame</code>則是有時候不得已用Code的方式呼叫：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">-</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="ss">initWithFrame</span><span class="p">:(</span><span class="no">CGRect</span><span class="p">)</span><span class="n">frame</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nb">self</span> <span class="o">=</span> <span class="o">[</span><span class="k">super</span> <span class="ss">initWithFrame</span><span class="p">:</span><span class="n">frame</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="sr">//</span> <span class="no">Initialization</span> <span class="n">code</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">autoresizesSubviews</span> <span class="o">=</span> <span class="no">YES</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>並且記得如果用Code呼叫要<code>Frame</code>，要在<code>viewDidAppear</code>這裡面做，因為根據<code>ViewController</code>這裡才是<code>Frame</code>經過<code>Autolayout</code>等計算後真正確定的地方。</p>

<h3>利用SizeClass</h3>

<p>比如轉向的需求，利用<code>Storyboard</code>的<code>SizeClass</code>在不同情境下就可以很輕易漂亮的適配出你要的螢幕Layout，比如影片橫幅要佔滿全螢幕等。</p>

<h2>Then&hellip;</h2>

<p>其實在Xcode裡面刻畫環境真的是很享受的過程，當你刻畫出的UI在<code>Storyboard</code>上跟UI出的圖一樣時，那樣的成就感很高。尤其Apple近幾年推出的<code>Autolayout</code>跟<code>SizeClass</code>其實都走在很前端的地方，給開發者很大的彈性與方便。</p>

<p>這裡也推薦這個網站Zeplin，我現在配合的設計師可以很方便地更新圖給大家，上面尺寸也都可以標註到很細，甚至這個網站還有Mac的APP，裡面有個特異功能是可以把素材匯進到專案的<code>Assets.xcassets</code>真的很棒！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/03/ios-fastlane/">運用iOS Fastlane自動化部署TestFlight</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-03T14:59:51+08:00" pubdate data-updated="true">May 3<sup>rd</sup>, 2016</time>
        
           | <a href="/blog/2016/05/03/ios-fastlane/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/05/03/ios-fastlane/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>老生常談得一件事情，如果一個團隊花一個禮拜的時間寫好自動部署的工具，比如用shell，把平常又臭又長或者很繁瑣的指令集結起來，之後這些繁瑣重複的工作就可以透過自動化工具省下不少時間。</p>

<blockquote><p>表面上看起來或許一年之後你才能把剩下來的那幾秒鐘累積成一個禮拜，達成回本的動作，但是如果你不這樣做，你把那一個禮拜的時間打散到一年裡面，換來的就是你一年的開發效率低落。</p>

<p>長遠看來，有沒有做自動化工具的團隊，差距可謂天與地。</p></blockquote>

<p>知道了自動化的重要性，再來就iOS而言有一套<a href="https://krausefx.com/blog/fastlane-is-now-part-of-fabric">國外Twitter青年才俊高富帥工程師從side project發展成全職開發的iOS自動化工具組</a>-fastlane，國外紅一陣子了，但中文的介紹似乎不多，秉持人飢己飢的精神(?)，也方便之後回顧，就來寫這篇吧。</p>

<p>首先我會先請你到官方文件那裡安裝必要的工具，之後我在介紹你tips，讓你可以快速達到自動部署上TestFlight的要求。
當然你之後可以串接Test的流程，確認沒問題了再上TestFlight。</p>

<p>首先到<a href="https://github.com/fastlane/fastlane">Fastlane</a>的GitHub上依照最新的<code>Installation</code>章節安裝好Fastlane。接著依照<code>Quick Start</code>章節的步驟建好初步的文件。這中間可能會問你App ID啦，Apple ID的帳密呀，諸如此類的基礎設定。</p>

<p>接著看到目錄裡面的Fastfile文件，下面文件已經是我改好可以Run的版本，跟初始化的版本會不太一樣，更下面我會介紹是怎麼改過來的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>desc "Submit a new Beta Build to Apple TestFlight"
</span><span class='line'>  desc "This will also make sure the profile is up to date"
</span><span class='line'>  lane :beta do
</span><span class='line'>    increment_build_number
</span><span class='line'>    # match(type: "appstore") # more information: https://codesigning.guide
</span><span class='line'>    gym(scheme: "SecureMedia", use_legacy_build_api: true) # Build your app - more options available
</span><span class='line'>    pilot(team_name: "CUTE LIMITED")
</span><span class='line'>
</span><span class='line'>    # sh "your_script.sh"
</span><span class='line'>    # You can also use other beta testing services here (run `fastlane actions`)
</span><span class='line'>  end</span></code></pre></td></tr></table></div></figure>


<p>看到<code>lane :beta do</code>，代表之後我們只要下<code>fastlane beta</code>就可以指定執行一直到<code>end</code>包起來的這個區塊的動作。</p>

<p>我們先定義我們的beta要做什麼事情:<br/>
1. 把cocoapod裝一次<br/>
2. 把build號碼+1<br/>
3. 用Production的Provisioning Profiles，build一個ipa出來<br/>
4. 把這個版本送到TestFlight上，並送給tester</p>

<p>基本上如果上述都手動的話，大約要花上15分鐘左右（切換Provisioning Profiles, 上傳時間, 還有等iTunes connect處理新版build, 最後再手動送出分發測試版本到tester手上），透過自動化工具可以做到打一行指令後就可以不理了。</p>

<p>上述流程在Fastlane裡面被寫成三行，這三行的設定tips就分三項介紹</p>

<h3>increment_build_number</h3>

<p>Literally，<code>increment_build_number</code>就是自動增加build版號，別小看這個功能，以前常常是都發布出去了才發現沒有新增版號！需要配合設定Xcode參數<code>Current Project Version</code>。參照圖片或<a href="http://www.markschabacker.com/blog/2013/01/04/agvtool_with_new_projects/">這邊</a>。</p>

<p><img src="http://mrshih.github.io/images/ios-fastlane-1.png" alt="image" /></p>

<h3>gym</h3>

<p>這是幫我們產生ipa檔案的。後面跟上兩個參數<code>scheme</code>通常就是你得App名稱，<code>use_legacy_build_api</code>，則是因為<a href="https://github.com/fastlane/gym/issues/104">Xcode 7.0的上傳API更改了，所以在使用時有時候會錯</a>，這時候要改用舊的。</p>

<h3>pilot</h3>

<p>這是幫我們自動部署到TestFlight的，使用時需要加上<code>team_name</code>參數是因為筆者帳號下有兩個Team，你如果不填上這個Fastlane跑到一半就會問你，這樣自動化就沒意義了。</p>

<p>然後記得搭配pilot時，Xcode要配合在<code>info.plist</code>加上下面這個屬性：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;key&gt;ITSAppUsesNonExemptEncryption&lt;/key&gt;
</span><span class='line'>&lt;false/&gt;</span></code></pre></td></tr></table></div></figure>


<p>討論串是說iTunes connect建議手動上傳要使用這個參數。相關討論在這個<a href="https://github.com/fastlane/pilot/issues/156">issue</a>頁。</p>

<h2>後記</h2>

<p>之後可以串接上Slack做完成時的顯示，再更進一步可以搭配Hubot，這樣連<code>fastlane beta</code>都省了。然後因為沒接觸CI Server，之後也可以研究兩者如何搭配。</p>

<p>其實筆者在用octopress發布文章的時候，明明指令沒幾行也硬是寫了三個shell來發布(new, preview, publish)，但實在是幫我省了很多時間，不然每次我可都要去google指令，很煩的。</p>

<p>只能說工程師的懶沒有極限，但正是這種懶造就了人類文明的進步（？）。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/01/detail-custom-ios-model-animation/">有關製作iOS客製化Animation的詳細過程</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-01T03:05:19+08:00" pubdate data-updated="true">May 1<sup>st</sup>, 2016</time>
        
           | <a href="/blog/2016/05/01/detail-custom-ios-model-animation/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/05/01/detail-custom-ios-model-animation/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>為何寫這篇</h2>

<p>前幾篇有寫到如何<a href="http://mrshih.github.io/blog/2016/01/08/first-presentation-flow/">製作SlideMenu</a>，大概講了cocoa framework在客製化<code>UIView</code>動畫的世界觀，這裡則寫一個手把手的詳細步驟，這樣搭配比較有感覺，不然Apple把class之間解構的這麼徹底，實在是東一個西一個的，一時之間不好下手。</p>

<h2>手把手開始</h2>

<p>0.建segue並且設立id<br/>
1.segue kind選custom<br/>
2.建立subclass(UIStoryboardSegue)<br/>
3.override perform function</p>

<blockquote><p>how to override perform function</p></blockquote>

<p>1.取得self.sourceViewController<br/>
2.取得self.destinationViewController<br/>
3.set destVC 的setModalPresentationStyle = UIModalPresentationCustom//顯示面積客製化<br/>
4.誰提供客製化的資訊呢？在這裡！ 建立一格subclass UIViewControllerTransitioningDelegate class(裡面怎麼實作請看段A)<br/>
5.set第四步的步驟為destVC的TransitioningDelegate<br/>
6.srcVC presentViewController destVC，動畫animated設置為YES</p>

<h2>段A</h2>

<blockquote><p>hwo to create a subclass <code>UIViewControllerTransitioningDelegate</code> 的object。</p>

<p>這裡就是實作perform跟dismiss的時候動畫要怎麼走的地方，還有系統要<code>UIPresentationController</code>的地方，簡單來說就是系統從這邊獲取怎麼客製化顯示範圍與顯示動畫的資訊。</p></blockquote>

<ul>
<li>1.提供override下面方法</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (UIPresentationController *)presentationControllerForPresentedViewController:(UIViewController *)presented presentingViewController:(UIViewController *)presenting sourceViewController:(UIViewController *)source{
</span><span class='line'>
</span><span class='line'>1.透過if ([presented isKindOfClass:AlbumMenuViewController class])來分別要提供對應PresentationController{
</span><span class='line'>2.建立一個subclass UIPresentationController的class。(怎麼建請看段B)
</span><span class='line'>3.透過UIPresentationController的父方法initWithPresentedViewController...(略)去instance這個PresentationController object。
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>2.override下面方法來提供prestedVC顯示時的動畫物件animator(從哪裡移動到哪裡，所以其實最後prestedVC的x,y是由這裡提供的動畫物件決定)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (id&lt;UIViewControllerAnimatedTransitioning&gt; _Nullable)animationControllerForPresentedController:(UIViewController * _Nonnull)presented presentingController:(UIViewController * _Nonnull)presenting sourceController:(UIViewController * _Nonnull)source{
</span><span class='line'>
</span><span class='line'>1.用if去知道你等等要回傳那個對應的animator
</span><span class='line'>if([presented isKindOfClass:[HelperTableViewController class]]){
</span><span class='line'>2.SlideMenuAnimator *animator = [[SlideMenuAnimator alloc]init];//製作一個實作UIViewControllerAnimatedTransitioning協議的animator class，怎麼做看段C
</span><span class='line'>3.[animator setPresenting:YES];// 我設計的animator可以同時包含出場與離場的動畫，這樣就不用寫兩個animator了，所以裡面有個參數可以選擇要回傳哪種動畫，這裡是出場就設定YES。
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>3.override下面方法來提供prestedVC dismiss時的動畫，功能如上，決定哪裡到哪裡</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (id&lt;UIViewControllerAnimatedTransitioning&gt; _Nullable)animationControllerForDismissedController:(UIViewController * _Nonnull)dismissed{
</span><span class='line'>1.用if去知道你等等要回傳那個對應的animator
</span><span class='line'>if([presented isKindOfClass:[HelperTableViewController class]]){
</span><span class='line'>2.SlideMenuAnimator *animator = [[SlideMenuAnimator alloc]init];//前面解釋過
</span><span class='line'>3.[animator setPresenting:NO];//前面解釋過
</span><span class='line'>}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>段B</h2>

<ul>
<li>1.override &ndash; <code>frameOfPresentedViewInContainerView</code>這個方法來指定prestenVC要顯示的&#8221;大小&#8221;，注意不包含位置(x,y)喔</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(CGRect)frameOfPresentedViewInContainerView
</span><span class='line'>{
</span><span class='line'>CGRect presentedViewFrame = CGRectZero;//我們要回傳的數值
</span><span class='line'>CGRect containerBounds = [[self containerView] bounds];//得到prestingVC的bounds
</span><span class='line'>// 到這裡你已經可以運加減乘除算出你要顯示的VC的大小，下面示範的是要根據ipad跟iphone做特別處理的做法
</span><span class='line'>
</span><span class='line'>if (self.traitCollection.userInterfaceIdiom == UIUserInterfaceIdiomPhone) {
</span><span class='line'>presentedViewFrame.size = CGSizeMake(floorf(containerBounds.size.width * 0.75),
</span><span class='line'>containerBounds.size.height);
</span><span class='line'>}else if(self.traitCollection.userInterfaceIdiom == UIUserInterfaceIdiomPad){
</span><span class='line'>presentedViewFrame.size = CGSizeMake(floorf(300),
</span><span class='line'>containerBounds.size.height);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>return presentedViewFrame;//最後當然是回傳
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<blockquote><p>補充：<br/>
除了override上面的方法去指定顯示大小外，你還可以override一些方法動態的去新增或拿掉view，比如切換VC時，prested如果沒有蓋滿presting，則剩下的地方可以放上一層黑色半透明的view來做區別。<br/>
下面是範例:</p></blockquote>

<ul>
<li>2.新增<code>property @property (nonatomic) UIView *dimmingView;</code></li>
<li>3.複寫下面兩個方法，一個是當要切換時做什麼，另一個是當要隱藏時做什麼。搭配起來就可以動態新增刪除陰影view</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)presentationTransitionWillBegin {
</span><span class='line'>
</span><span class='line'>self.dimmingView = [[UIView alloc]init];
</span><span class='line'>[self.dimmingView setFrame:self.containerView.frame];
</span><span class='line'>[self.dimmingView setBackgroundColor:[UIColor blackColor]];
</span><span class='line'>[self.dimmingView setAlpha:0.3f];
</span><span class='line'>
</span><span class='line'>// Add a custom dimming view behind the presented view controller's view
</span><span class='line'>[[self containerView] addSubview:self.dimmingView];
</span><span class='line'>[self.dimmingView addSubview:[[self presentedViewController] view]];
</span><span class='line'>
</span><span class='line'>#pragma clang diagnostic push
</span><span class='line'>#pragma clang diagnostic ignored "-Wundeclared-selector"
</span><span class='line'>UITapGestureRecognizer *dimmingViewSingleTap =
</span><span class='line'>[[UITapGestureRecognizer alloc] initWithTarget:self.presentingViewController
</span><span class='line'>action:@selector(handleDimmingViewSingleTap)];
</span><span class='line'>#pragma clang diagnostic pop
</span><span class='line'>[self.dimmingView addGestureRecognizer:dimmingViewSingleTap];
</span><span class='line'>
</span><span class='line'>// Fade in the dimming view during the transition.
</span><span class='line'>[self.dimmingView setAlpha:0.0];
</span><span class='line'>// Use the transition coordinator to set up the animations.
</span><span class='line'>[[[self presentingViewController] transitionCoordinator] animateAlongsideTransition:^(id&lt;UIViewControllerTransitionCoordinatorContext&gt;  _Nonnull context) {
</span><span class='line'>[self.dimmingView setAlpha:0.55];
</span><span class='line'>} completion:^(id&lt;UIViewControllerTransitionCoordinatorContext&gt;  _Nonnull context) {
</span><span class='line'>
</span><span class='line'>}];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<blockquote><p>在dismiss做一些額外coustom的事情，在這裡用讓dimmingView淡出來當例子</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)dismissalTransitionWillBegin {
</span><span class='line'>[[[self presentingViewController] transitionCoordinator] animateAlongsideTransition:^(id&lt;UIViewControllerTransitionCoordinatorContext&gt;  _Nonnull context) {
</span><span class='line'>[self.dimmingView setAlpha:0.0];
</span><span class='line'>} completion:^(id&lt;UIViewControllerTransitionCoordinatorContext&gt;  _Nonnull context) {
</span><span class='line'>
</span><span class='line'>}];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>段C</h2>

<ul>
<li>4.override下面方法，可以拿來改變一些基於class size變化的改變。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)viewWillTransitionToSize:(CGSize)size withTransitionCoordinator:(id&lt;UIViewControllerTransitionCoordinator&gt;)coordinator 
</span><span class='line'>
</span><span class='line'>//製作實作UIViewControllerAnimatedTransitioning協議的animator，系統會去這裡要VC的初始位置跟Final位置，系統再去補齊動畫。
</span><span class='line'>//1 override 下面function來提供動畫內容（兩個位置）
</span><span class='line'>- (void)animateTransition:(id&lt;UIViewControllerContextTransitioning&gt; _Nonnull)transitionContext {
</span><span class='line'>1.// 主畫布
</span><span class='line'>UIView *containerView = [transitionContext containerView];
</span><span class='line'>
</span><span class='line'>2.// 對進場來說（toVC是prestedVC），拿到後可以再去拿VC的view
</span><span class='line'>UIViewController *toVC   = [transitionContext
</span><span class='line'>viewControllerForKey:UITransitionContextToViewControllerKey];
</span><span class='line'>
</span><span class='line'>3.// 對進場來說（fromVC是prestingVC)，拿到後可以再去拿VC的view
</span><span class='line'>UIViewController *fromVC = [transitionContext
</span><span class='line'>viewControllerForKey:UITransitionContextFromViewControllerKey];
</span><span class='line'>
</span><span class='line'>4.//取得view，後面動畫主要就是都在操作這裡
</span><span class='line'>UIView *toView = [transitionContext viewForKey:UITransitionContextToViewKey];
</span><span class='line'>UIView *fromView = [transitionContext viewForKey:UITransitionContextFromViewKey];
</span><span class='line'>
</span><span class='line'>5.//取得兩個VC的最終大小，大小是在frameOfPresentedViewInContainerView決定。
</span><span class='line'>// Set up some variables for the animation.
</span><span class='line'>CGRect containerFrame = containerView.frame;
</span><span class='line'>CGRect toViewStartFrame = [transitionContext initialFrameForViewController:toVC];
</span><span class='line'>CGRect fromViewStartFrame = [transitionContext initialFrameForViewController:fromVC];
</span><span class='line'>CGRect toViewFinalFrame = [transitionContext finalFrameForViewController:toVC];
</span><span class='line'>CGRect fromViewFinalFrame = [transitionContext finalFrameForViewController:fromVC];
</span><span class='line'>
</span><span class='line'>6.// 開始作畫 Add toVC's view to containerView
</span><span class='line'>// 把toView加進來
</span><span class='line'>[containerView addSubview:toView];
</span><span class='line'>
</span><span class='line'>7.//決定一開始的frame
</span><span class='line'>if (self.presenting) {
</span><span class='line'>//這邊直接用預設的
</span><span class='line'>CGSize size = toViewFinalFrame.size;
</span><span class='line'>[toView setFrame:CGRectMake(0, containerFrame.size.height+toViewFinalFrame.size.height, size.width, size.height)];//size一樣。x=0,y=總高度+toView的高
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//決定最終的frame
</span><span class='line'>if (self.presenting) {
</span><span class='line'>[UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^{
</span><span class='line'>//大小一樣。位置就只要到x=0, y=總高度-toView高度
</span><span class='line'>CGSize size = toViewFinalFrame.size;
</span><span class='line'>CGPoint point = CGPointMake(0, containerFrame.size.height-toViewFinalFrame.size.height);
</span><span class='line'>[toView setFrame:CGRectMake(point.x, point.y, size.width, size.height)];
</span><span class='line'>}completion:^(BOOL finished) {
</span><span class='line'>// 3.Cleaning up and completing the transition.
</span><span class='line'>[transitionContext completeTransition:YES];
</span><span class='line'>}];
</span><span class='line'>}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>5.override來提供動畫時間</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (NSTimeInterval)transitionDuration:(id&lt;UIViewControllerContextTransitioning&gt; _Nullable)transitionContext {
</span><span class='line'>return 0.2f;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/27/why-to-be-a-cs-engineer/">為什麼要當個CS工程師</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-04-27T15:00:00+08:00" pubdate data-updated="true">Apr 27<sup>th</sup>, 2016</time>
        
           | <a href="/blog/2016/04/27/why-to-be-a-cs-engineer/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/04/27/why-to-be-a-cs-engineer/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在電腦科學的領域裡面打滾這幾年發現一件事，當你能夠橫向操縱越多領域的工具，組合出來東西往往價值會很高。比如要組合一個APP開門鎖系統橫向需要連結PHP, Pthon, Objective-C, HTML約四種語言，其實每一種都不用太深入，單組合出來的系統往往一般人一時半刻不了解，需要問你是怎麼兜出來得。</p>

<p>這個發現在最近開發的新應用系統也得到驗證。其實可以這麼看，新的系統往往是由過往的工具所搭建出來，賦予新名稱，創造出新功能，如此而已。每個語言與工具有擅長的地方，拿上面提到的開鎖系統為例：</p>

<blockquote><ol>
<li>Liunx+Apache+MySql+PHP+HTML = 家裡接收開鎖請求的Server</li>
<li>Raspberry Pi + Python = 負責控制馬達開鎖的模組</li>
<li>Objective-C     = 當然就負責遠端送訊號，自動感應是不是快到家了</li>
<li>ibeacon = 放在門附近負責讓手機知道自己快到家了</li>
</ol>
</blockquote>

<p>第一點其實資訊相關科技畢業基本一定要會，不然讀資訊科系真的是可惜。接下的幾點需要你能夠不怕生的上網找資料，並且學著去試試看。</p>

<h2>何謂試試看?</h2>

<p>打個比方，蜘蛛人一開始也不知道怎麼吐絲，所以他第一步不會直接把蜘蛛絲噴到摩天大樓，然後試著在大樓建拋來拋去。第一步當然是所謂的Hello, World。</p>

<p>幾乎每個工具或語言都有提供Quick start guide，你會找上這個工具就代表你應該有先上網Google過，發現這個工具可以幫你解決問題，而接下來就是照著文章去試試看。很多人不敢試是因為害怕失敗，但我想說得是每個看似風光厲害完成些什麼的工程師都是Error Message海裡面爬出來的。遇到錯誤訊息就去Google，就這麼簡單。想要什麼功能就把手弄髒去做就對了。</p>

<h2>失敗到心寒</h2>

<p>很多人其實卡死在這裡。前面說到Error的數量，確定程式設計師的力量，但要如何撐過Error海？這就要說到理想跟錢了。你為什麼選擇程式設計？</p>

<p>程式設計在可預見的30年內一定還會一直缺人，越缺越大而已，說直白的很混的可以就溫飽三餐小確幸，強的可以過得非常爽，而其他職業在未來只會被軟體吞掉而已。你選擇了這個看似高大上的行業，可以做的事情真的很多很多，幾乎是一個應許之地。你對前端沒興趣可以走後端，也可以轉資料庫，轉Hacker，轉Linux設定架設維護寫Shall&hellip;</p>

<p>做這個行業傲嬌的點應該在於對別人來說，你就像魔法師，有沒有用過星巴克QR Code掃一掃就可以付錢？Uber有搭乘過嗎？為什麼有人說Line不安全，那什麼是安全的軟體？在未來世界大家都離不開軟體，對一般人而已這一切都像是魔術，而程式設計可以了解背後資訊的流動，你可以解釋這一切magic一般的事情。強一點的之後你可以創造Magic，有這麼神奇的技能那有人願意付你錢真的是理所當然。</p>

<p>你要對自己身為魔術師感到驕傲，這幫助我在Error海裡面保持一顆赤子之心。</p>

<h2>Be傲嬌</h2>

<p>當你靠著自己得力量打造一個自豪的小系統，有人看到你的才能，你也相信自己的才能，自然而然你會得到錢，會得到自信，一切都像滾雪球一般停不下來。這個時代需要這樣的技能，選擇大於努力，跟對領域能事半功倍。</p>

<p>最後還是要補一句，學資訊系統的過程當然痛苦，但如果你物慾很強，夢想開拉風跑車，去普及島度假住水上小屋，還是一句話，你可以選擇繼續鬱卒，也可以選擇努力，花的力氣跟時間是一樣的，而程式設計這一條路可以是個方向。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/05/ios-camera-design-pattern-review/">iOS Camera Design Pattern 回顧</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-05T15:00:00+08:00" pubdate data-updated="true">Feb 5<sup>th</sup>, 2016</time>
        
           | <a href="/blog/2016/02/05/ios-camera-design-pattern-review/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/02/05/ios-camera-design-pattern-review/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>主題：要刪除某張照片?</h2>

<pre><code>- Beat Practice 應該要由Model做發起去通知資料已變化。比如刪除照片： 
    1.  由某個UIButton觸發Model的Delete方法
    2.  Model做處理，處理完之後去通知相關連的ViewModel去更新（Notification）
    3.  ViewModel收到needUpdate通知，去Fetch並整理資料，最後通知View Reload
</code></pre>

<p>未完&hellip;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/08/first-presentation-flow/">iOS 實作SlideMenu - 初探ViewController切換</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-08T18:10:00+08:00" pubdate data-updated="true">Jan 8<sup>th</sup>, 2016</time>
        
           | <a href="/blog/2016/01/08/first-presentation-flow/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/01/08/first-presentation-flow/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/2016-01-08-first-presentation-flow.jpg" />
所有關於ViewController切換的行為基本稱做為Model，Navegation特有的Push等等也是Model的分支。 在iOS7裡面把制定切換ViewController的行為拆分成許多Class，目的是為了要降低耦合，讓Code重用度提高，比如Coustom一個切換Animation物件可以用在好幾個ViewController之間。</p>

<p>要切換ViewController你要告訴UIKit兩件事情，顯示成怎樣<code>
UIModalPresentationStyle
</code>和過場動畫<code>Animations</code>。</p>

<h2>UIModalPresentationStyle</h2>

<p><code>UIModalPresentationStyle</code>是<code>UIViewController</code>裡的參數。定義了Presented最終呈現的樣式，比如：</p>

<ul>
<li>覆蓋全螢幕類的<code>UIModalPresentationFullScreen</code></li>
<li>iPad上常見的<code>UIModalPresentationPopover</code></li>
<li><code>UIModalPresentationCurrentContext</code>指定特定ViewController去做覆蓋</li>
<li>而我們想要的Slide Menu這樣的顯示效果不是上面幾種類型的，我們就必須要Coustom一個。也就必須實作<code>TransitioningDelegate</code>來提供下面兩種物件：

<ul>
<li><code>UIPresentationController</code></li>
<li>實作<code>UIViewControllerAnimatedTransitioning</code>的Animation</li>
</ul>
</li>
</ul>


<p>兩個物件後面會提到怎麼產生。</p>

<h2>使用Segue切換View Controller</h2>

<p>用Code寫的話常見做法是在Prestenting View Controller裡面呼叫<code>presentViewController</code>。而在這個可視化當道的年代當然要配合Storyboard搭配Segue才不會在未來多螢幕適配被淘汰掉。</p>

<p>在StoryBoard裡面拉出一條Segue，並且把Kind指定成Coustom。這樣就是告訴StoryBoard我們不用UIKit內建的展示和轉場效果，要自己建立一個Subcalss<code>UIStoryboardSegue</code>的Coustom Segue物件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@interface</span> <span class="no">SlideLeftCustomSegue</span> <span class="p">:</span> <span class="no">UIStoryboardSegue</span>
</span></code></pre></td></tr></table></div></figure>


<p>在這裡只要實作<code>perform</code>方法，在裡面設定：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">//</span> <span class="err">系統調用</span><span class="n">prepareForSegue</span><span class="err">就是調用這裡</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">perform</span><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">UIViewController</span> <span class="o">*</span><span class="n">srcViewController</span> <span class="o">=</span> <span class="p">(</span><span class="no">UIViewController</span> <span class="o">*</span><span class="p">)</span> <span class="nb">self</span><span class="o">.</span><span class="n">sourceViewController</span><span class="p">;</span>
</span><span class='line'>    <span class="no">SettingTableViewController</span> <span class="o">*</span><span class="n">destViewController</span> <span class="o">=</span> <span class="p">(</span><span class="no">SettingTableViewController</span> <span class="o">*</span><span class="p">)</span> <span class="nb">self</span><span class="o">.</span><span class="n">destinationViewController</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">SlideMenuShowTransition</span> <span class="o">*</span><span class="n">trainstionDelegate</span> <span class="o">=</span> <span class="o">[[</span><span class="no">SlideMenuShowTransition</span> <span class="n">alloc</span><span class="o">]</span><span class="n">init</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="o">[</span><span class="n">destViewController</span> <span class="ss">setTd</span><span class="p">:</span><span class="n">trainstionDelegate</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="sr">//</span><span class="err">把</span><span class="no">Presented</span> <span class="no">View</span> <span class="no">Controller</span><span class="err">的</span><span class="sb">`ModalPresentationStyle屬性改成UIModalPresentationCustom</span>
</span><span class='line'><span class="sb">    [destViewController setModalPresentationStyle:UIModalPresentationCustom];</span>
</span><span class='line'><span class="sb">    </span>
</span><span class='line'><span class="sb">    //設置TransitioningDelegate。這個代理主要用來提供待會兒切換會用到的所有物件。下面會介紹到</span>
</span><span class='line'><span class="sb">    [destViewController setTransitioningDelegate:trainstionDelegate];</span>
</span><span class='line'><span class="sb">    </span>
</span><span class='line'><span class="sb">    //最後呼叫presentViewController，來呼叫UIKit做開始切換</span>
</span><span class='line'><span class="sb">    [srcViewController presentViewController:destViewController animated:YES completion:nil];</span>
</span><span class='line'><span class="sb">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>TransitioningDelegate</h2>

<p>當系統發現Predented View Controller指定<code>ModalPresentationStyle</code>參數為<code>UIModalPresentationCustom</code>時，就會去呼叫<code>TransitioningDelegate</code>來提供上面有提到Model切換轉場所需的相關物件：<code>UIPresentationController</code>與Animation。</p>

<p>只要創一個實作<code>TransitioningDelegate</code>的NSObject，並指定給Presented View Controller就可以了。</p>

<p>執行的時候UIKit會先抓UIPresentaionController再依照情況抓取要的Animaion物件。</p>

<ol>
<li>提交<code>UIPresentaionController</code>來決定Presented View的Final的Frame。</li>
<li>提交所有轉場，包誇Present View Controller進來, Dismiss View Controller，還有交互等等。我們這裡簡單討論Present還有Dismiss的Animation物件怎麼做。</li>
</ol>


<p>系統會先抓<code>UIPresentaionController</code>一部分是因為Animation物件需要知道Prested View Final Frame。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">//</span> <span class="n">present</span><span class="err">時</span><span class="n">uikit</span><span class="err">會從這裡拿資料</span><span class="o">&lt;</span><span class="err">過場動畫</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="nb">id</span><span class="o">&lt;</span><span class="no">UIViewControllerAnimatedTransitioning</span><span class="o">&gt;</span> <span class="n">_Nullable</span><span class="p">)</span><span class="ss">animationControllerForPresentedController</span><span class="p">:(</span><span class="no">UIViewController</span> <span class="o">*</span> <span class="n">_Nonnull</span><span class="p">)</span><span class="n">presented</span> <span class="ss">presentingController</span><span class="p">:(</span><span class="no">UIViewController</span> <span class="o">*</span> <span class="n">_Nonnull</span><span class="p">)</span><span class="n">presenting</span> <span class="ss">sourceController</span><span class="p">:(</span><span class="no">UIViewController</span> <span class="o">*</span> <span class="n">_Nonnull</span><span class="p">)</span><span class="n">source</span> <span class="p">{</span>
</span><span class='line'>    <span class="no">SlideMenuAnimator</span> <span class="o">*</span><span class="n">animator</span> <span class="o">=</span> <span class="o">[[</span><span class="no">SlideMenuAnimator</span> <span class="n">alloc</span><span class="o">]</span><span class="n">init</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="o">[</span><span class="n">animator</span> <span class="ss">setPresenting</span><span class="p">:</span><span class="no">YES</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">animator</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="sr">//</span> <span class="n">dismiss</span><span class="err">時</span><span class="n">uikit</span><span class="err">會從這裡拿資料</span><span class="o">&lt;</span><span class="err">過場動畫</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="nb">id</span><span class="o">&lt;</span><span class="no">UIViewControllerAnimatedTransitioning</span><span class="o">&gt;</span> <span class="n">_Nullable</span><span class="p">)</span><span class="ss">animationControllerForDismissedController</span><span class="p">:(</span><span class="no">UIViewController</span> <span class="o">*</span> <span class="n">_Nonnull</span><span class="p">)</span><span class="n">dismissed</span> <span class="p">{</span>
</span><span class='line'>    <span class="no">SlideMenuAnimator</span> <span class="o">*</span><span class="n">animator</span> <span class="o">=</span> <span class="o">[[</span><span class="no">SlideMenuAnimator</span> <span class="n">alloc</span><span class="o">]</span><span class="n">init</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="o">[</span><span class="n">animator</span> <span class="ss">setPresenting</span><span class="p">:</span><span class="no">NO</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">animator</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="sr">//</span> <span class="no">UIKit</span><span class="err">在切換之初從這裡要</span><span class="no">UIPresentationController</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="no">UIPresentationController</span> <span class="o">*</span><span class="p">)</span><span class="ss">presentationControllerForPresentedViewController</span><span class="p">:</span>
</span><span class='line'><span class="p">(</span><span class="no">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="n">presented</span>
</span><span class='line'>                                                      <span class="ss">presentingViewController</span><span class="p">:(</span><span class="no">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="n">presenting</span>
</span><span class='line'>                                                          <span class="ss">sourceViewController</span><span class="p">:(</span><span class="no">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="n">source</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">SlideMenuPresentaionController</span><span class="o">*</span> <span class="n">myPresentation</span> <span class="o">=</span> <span class="o">[[</span><span class="no">SlideMenuPresentaionController</span> <span class="n">alloc</span><span class="o">]</span>
</span><span class='line'>                                                <span class="ss">initWithPresentedViewController</span><span class="p">:</span><span class="n">presented</span> <span class="ss">presentingViewController</span><span class="p">:</span><span class="n">presenting</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">myPresentation</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>UIPresentationController</h2>

<p>在iOS 7裡面引進了這個<code>UIPresentationController</code>，可以決定以下事情</p>

<ul>
<li>Set the size of the presented view controller.</li>
<li>Add custom views to change the visual appearance of the presented content.</li>
<li>Supply transition animations for any of its custom views.</li>
<li>Adapt the visual appearance of the presentation when changes occur in the app’s environment.（之後另設補充）</li>
</ul>


<p>這裡只先介紹前三項，指定Presented View Frame的方法，還有額外增加Coustom View如陰影層的方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">//</span> <span class="err">決定了使用</span><span class="no">UIModalPresentationCustom</span><span class="err">這樣的</span><span class="no">Model</span><span class="err">切換方式，就可以在這裡直接指定</span><span class="no">PresentedView</span><span class="err">的</span><span class="n">frame</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="no">CGRect</span><span class="p">)</span><span class="n">frameOfPresentedViewInContainerView</span> <span class="p">{</span>
</span><span class='line'>    <span class="no">CGRect</span> <span class="n">presentedViewFrame</span> <span class="o">=</span> <span class="no">CGRectZero</span><span class="p">;</span>
</span><span class='line'>    <span class="no">CGRect</span> <span class="n">containerBounds</span> <span class="o">=</span> <span class="o">[[</span><span class="nb">self</span> <span class="n">containerView</span><span class="o">]</span> <span class="n">bounds</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">presentedViewFrame</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="no">CGSizeMake</span><span class="p">(</span><span class="n">floorf</span><span class="p">(</span><span class="n">containerBounds</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">0</span><span class="o">.</span><span class="mi">7</span><span class="p">),</span>
</span><span class='line'>                                         <span class="n">containerBounds</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">presentedViewFrame</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="sr">//</span> <span class="no">Present</span><span class="err">的時候可以增加一些</span><span class="no">Coustom</span> <span class="no">View</span><span class="err">，靠</span><span class="n">animateAlongsideTransition</span><span class="err">來顯示新增的</span><span class="no">Coustom</span><span class="err">過場動畫</span>
</span><span class='line'><span class="sr">//</span> <span class="err">這裡用</span><span class="n">dimmingView</span><span class="err">來做</span><span class="no">Coustom</span> <span class="no">View</span><span class="err">的例子</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">presentationTransitionWillBegin</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="o">=</span> <span class="o">[[</span><span class="no">UIView</span> <span class="n">alloc</span><span class="o">]</span><span class="n">init</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="ss">setFrame</span><span class="p">:</span><span class="nb">self</span><span class="o">.</span><span class="n">containerView</span><span class="o">.</span><span class="n">frame</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="ss">setBackgroundColor</span><span class="p">:</span><span class="o">[</span><span class="no">UIColor</span> <span class="n">blackColor</span><span class="o">]]</span><span class="p">;</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="ss">setAlpha</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">f</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="sr">//</span> <span class="no">Add</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">dimming</span> <span class="n">view</span> <span class="n">behind</span> <span class="n">the</span> <span class="n">presented</span> <span class="n">view</span> <span class="n">controller</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">view</span>
</span><span class='line'>    <span class="o">[[</span><span class="nb">self</span> <span class="n">containerView</span><span class="o">]</span> <span class="ss">addSubview</span><span class="p">:</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="ss">addSubview</span><span class="p">:</span><span class="o">[[</span><span class="nb">self</span> <span class="n">presentedViewController</span><span class="o">]</span> <span class="n">view</span><span class="o">]]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#pragma clang diagnostic push</span>
</span><span class='line'><span class="c1">#pragma clang diagnostic ignored &quot;-Wundeclared-selector&quot;</span>
</span><span class='line'>    <span class="no">UITapGestureRecognizer</span> <span class="o">*</span><span class="n">dimmingViewSingleTap</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">[[</span><span class="no">UITapGestureRecognizer</span> <span class="n">alloc</span><span class="o">]</span> <span class="ss">initWithTarget</span><span class="p">:</span><span class="nb">self</span><span class="o">.</span><span class="n">presentingViewController</span>
</span><span class='line'>                                            <span class="ss">action</span><span class="p">:</span><span class="vi">@selector</span><span class="p">(</span><span class="n">handleDimmingViewSingleTap</span><span class="p">)</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="c1">#pragma clang diagnostic pop</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="ss">addGestureRecognizer</span><span class="p">:</span><span class="n">dimmingViewSingleTap</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="sr">//</span> <span class="no">Fade</span> <span class="k">in</span> <span class="n">the</span> <span class="n">dimming</span> <span class="n">view</span> <span class="n">during</span> <span class="n">the</span> <span class="n">transition</span><span class="o">.</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="ss">setAlpha</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="sr">//</span> <span class="no">Use</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">coordinator</span> <span class="n">to</span> <span class="n">set</span> <span class="n">up</span> <span class="n">the</span> <span class="n">animations</span><span class="o">.</span>
</span><span class='line'>    <span class="o">[[[</span><span class="nb">self</span> <span class="n">presentingViewController</span><span class="o">]</span> <span class="n">transitionCoordinator</span><span class="o">]</span> <span class="ss">animateAlongsideTransition</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="nb">id</span><span class="o">&lt;</span><span class="no">UIViewControllerTransitionCoordinatorContext</span><span class="o">&gt;</span>  <span class="n">_Nonnull</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="ss">setAlpha</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">55</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="ss">completion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="nb">id</span><span class="o">&lt;</span><span class="no">UIViewControllerTransitionCoordinatorContext</span><span class="o">&gt;</span>  <span class="n">_Nonnull</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">dismissalTransitionWillBegin</span> <span class="p">{</span>
</span><span class='line'>    <span class="o">[[[</span><span class="nb">self</span> <span class="n">presentingViewController</span><span class="o">]</span> <span class="n">transitionCoordinator</span><span class="o">]</span> <span class="ss">animateAlongsideTransition</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="nb">id</span><span class="o">&lt;</span><span class="no">UIViewControllerTransitionCoordinatorContext</span><span class="o">&gt;</span>  <span class="n">_Nonnull</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">dimmingView</span> <span class="ss">setAlpha</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="ss">completion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="nb">id</span><span class="o">&lt;</span><span class="no">UIViewControllerTransitionCoordinatorContext</span><span class="o">&gt;</span>  <span class="n">_Nonnull</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Animation</h2>

<p>建立一個實作<code>UIViewControllerAnimatedTransitioning</code> protocol的<code>NSObject</code>，裡面會有系統傳入的<code>UIViewControllerContextTransitioning</code>，這裡面會包含你後面要做動畫所需的所有物件。</p>

<p>主要兩個方法，一個方法專門玩動畫，一個方法單純回傳動畫所需時間。</p>

<p>我們可以把Present和Dismiss的動畫寫在一起，但<code>transitionContext</code>傳入的資訊什麼都有，就是沒有現在是Present還是Dismiss狀態的參數。</p>

<p>所以要自己設一個，並且在<code>TransitioningDelegate</code>回傳動畫方法時指定給Animation物件知道:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@interface</span> <span class="no">SlideMenuAnimator</span> <span class="p">:</span> <span class="no">NSObject</span><span class="o">&lt;</span><span class="no">UIViewControllerAnimatedTransitioning</span><span class="o">&gt;</span>
</span><span class='line'><span class="vi">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="no">Boolean</span> <span class="n">presenting</span><span class="p">;</span>
</span><span class='line'><span class="vi">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">//</span> <span class="err">這裡</span><span class="no">UIKit</span><span class="err">會給我們兩個</span><span class="no">View</span><span class="err">，包在</span><span class="n">transitionContext</span><span class="err">裡面，只要取出來玩就好了</span>
</span><span class='line'><span class="sr">//</span> <span class="err">這裡是真的作動畫的地方</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="ss">animateTransition</span><span class="p">:(</span><span class="nb">id</span><span class="o">&lt;</span><span class="no">UIViewControllerContextTransitioning</span><span class="o">&gt;</span> <span class="n">_Nonnull</span><span class="p">)</span><span class="n">transitionContext</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="sr">//</span> <span class="no">Get</span> <span class="n">the</span> <span class="n">set</span> <span class="n">of</span> <span class="n">relevant</span> <span class="n">objects</span><span class="o">.</span>
</span><span class='line'>    <span class="no">UIView</span> <span class="o">*</span><span class="n">containerView</span> <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span> <span class="n">containerView</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="no">UIViewController</span> <span class="o">*</span><span class="n">fromVC</span> <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span>
</span><span class='line'>                                <span class="ss">viewControllerForKey</span><span class="p">:</span><span class="no">UITransitionContextFromViewControllerKey</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="no">UIViewController</span> <span class="o">*</span><span class="n">toVC</span>   <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span>
</span><span class='line'>                                <span class="ss">viewControllerForKey</span><span class="p">:</span><span class="no">UITransitionContextToViewControllerKey</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">UIView</span> <span class="o">*</span><span class="n">toView</span> <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span> <span class="ss">viewForKey</span><span class="p">:</span><span class="no">UITransitionContextToViewKey</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="no">UIView</span> <span class="o">*</span><span class="n">fromView</span> <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span> <span class="ss">viewForKey</span><span class="p">:</span><span class="no">UITransitionContextFromViewKey</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="sr">//</span> <span class="no">Set</span> <span class="n">up</span> <span class="n">some</span> <span class="n">variables</span> <span class="k">for</span> <span class="n">the</span> <span class="n">animation</span><span class="o">.</span>
</span><span class='line'>    <span class="sr">//</span><span class="no">CGRect</span> <span class="n">containerFrame</span> <span class="o">=</span> <span class="n">containerView</span><span class="o">.</span><span class="n">frame</span><span class="p">;</span>
</span><span class='line'>    <span class="sr">//</span><span class="no">CGRect</span> <span class="n">toViewStartFrame</span> <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span> <span class="ss">initialFrameForViewController</span><span class="p">:</span><span class="n">toVC</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="no">CGRect</span> <span class="n">fromViewStartFrame</span> <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span> <span class="ss">initialFrameForViewController</span><span class="p">:</span><span class="n">fromVC</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="no">CGRect</span> <span class="n">toViewFinalFrame</span> <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span> <span class="ss">finalFrameForViewController</span><span class="p">:</span><span class="n">toVC</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="no">CGRect</span> <span class="n">fromViewFinalFrame</span> <span class="o">=</span> <span class="o">[</span><span class="n">transitionContext</span> <span class="ss">finalFrameForViewController</span><span class="p">:</span><span class="n">fromVC</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="sr">//</span> <span class="mi">3</span><span class="o">.</span> <span class="no">Add</span> <span class="n">toVC</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">view</span> <span class="n">to</span> <span class="n">containerView</span>
</span><span class='line'>    <span class="o">[</span><span class="n">containerView</span> <span class="ss">addSubview</span><span class="p">:</span><span class="n">toView</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">presenting</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">[</span><span class="n">toView</span> <span class="ss">setFrame</span><span class="p">:</span><span class="no">CGRectOffset</span><span class="p">(</span><span class="n">toViewFinalFrame</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">toViewFinalFrame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">[</span><span class="n">fromView</span> <span class="ss">setFrame</span><span class="p">:</span><span class="n">fromViewStartFrame</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sr">//</span> <span class="no">Creating</span> <span class="n">the</span> <span class="n">animations</span> <span class="n">using</span> <span class="no">Core</span> <span class="no">Animation</span> <span class="ow">or</span> <span class="no">UIView</span> <span class="n">animation</span> <span class="nb">methods</span><span class="o">.</span>
</span><span class='line'>    <span class="o">[</span><span class="no">UIView</span> <span class="ss">animateWithDuration</span><span class="p">:</span><span class="o">[</span><span class="nb">self</span> <span class="ss">transitionDuration</span><span class="p">:</span><span class="n">transitionContext</span><span class="o">]</span> <span class="ss">animations</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">presenting</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">toView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">toViewFinalFrame</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fromView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectOffset</span><span class="p">(</span><span class="n">fromViewFinalFrame</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">fromViewFinalFrame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="ss">completion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="no">BOOL</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="sr">//</span> <span class="mi">3</span><span class="o">.</span><span class="n">Cleaning</span> <span class="n">up</span> <span class="ow">and</span> <span class="n">completing</span> <span class="n">the</span> <span class="n">transition</span><span class="o">.</span>
</span><span class='line'>        <span class="o">[</span><span class="n">transitionContext</span> <span class="ss">completeTransition</span><span class="p">:</span><span class="no">YES</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>嚴謹有序的切換View Controller Flow</h2>

<p>到這邊就可以做出一個會動，有PresentingView有陰影Mask的SlideMenu了，視覺上是仿照Google Photo。基本上iOS 7所引進的這些許多新方法都是為了要解構，使之可以更容易管理，更有邏輯性。</p>

<p>有關切換ViewController來有些重要Feature，留待之後想到應用實作再增加</p>

<ul>
<li>InteractiveTransition交互動畫的部分</li>
<li>跟<code>UIPresentationController</code>適配不同場景的應用Adapting to Different Size Classes</li>
</ul>


<h3>參考資料</h3>

<p> <a href="https://developer.apple.com/videos/play/wwdc2014-228/">https://developer.apple.com/videos/play/wwdc2014-228/</a>
&ndash; <a href="http://onevcat.com/2013/10/vc-transition-in-ios7/">http://onevcat.com/2013/10/vc-transition-in-ios7/</a>
&ndash; <a href="https://developer.apple.com/library/ios/featuredarticles/ViewControllerPGforiPhoneOS/DefiningCustomPresentations.html#//apple_ref/doc/uid/TP40007457-CH25-SW1">https://developer.apple.com/library/ios/featuredarticles/ViewControllerPGforiPhoneOS/DefiningCustomPresentations.html#//apple_ref/doc/uid/TP40007457-CH25-SW1</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/04/ios-serial-queue-run-async-background-job/">iOS 大量網路與硬碟I/0處理</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-04T15:00:00+08:00" pubdate data-updated="true">Jan 4<sup>th</sup>, 2016</time>
        
           | <a href="/blog/2016/01/04/ios-serial-queue-run-async-background-job/#disqus_thread"
             data-disqus-identifier="http://sah.tw/blog/2016/01/04/ios-serial-queue-run-async-background-job/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>很多時候操作網路或者Disk的I/O，我們都會把工作丟到背景去執行，避免凍結使用者的畫面。但是這造成一個問題是一下子太多背景任務同時執行有可能導致APP崩潰。</p>

<p>比如影音APP使用者見獵心喜，一下子選了許多部影片要下載，如果現在把下載任務一股腦兒丟到背景，因為現在大部分下載需求都直接使用知名框架<code>AFNetworking</code>，而裡面的方法通常也都直接在背景運行，造成這些下載任務用Concurrent的方式併發執行，這下子產生大量的網路還有Disk I/O Request同時在背景跑。</p>

<p>UI是不會被凍結沒錯，但很有可能背景操作網路或Disk I/O的量太多（通常是Disk），導致APP崩潰。</p>

<h2>以Serial思維執行背景任務</h2>

<p>這時候就非常建議一次下載並儲存一部影片就好。也就是確保上個任務執行完畢，Queue在推送下一個任務去執行。</p>

<h2>混亂的完成順序</h2>

<p>直觀的實作方式就是建立一個Serial Queue，把需要列隊執行的任務用<code>dispatch_async</code>加入進去，就像以下方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">//</span> <span class="err">建立一個唯一的</span><span class="no">Serial</span> <span class="no">Queue</span>
</span><span class='line'><span class="n">dispatch_queue_t</span> <span class="n">_uploadToParseInBackgroundQueue</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">static</span> <span class="n">dispatch_once_t</span> <span class="n">queueCreationGuard</span><span class="p">;</span>
</span><span class='line'>    <span class="n">static</span> <span class="n">dispatch_queue_t</span> <span class="n">queue</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queueCreationGuard</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s2">&quot;com.shih.secureMedia.uploadToParseInBackgroundQueue&quot;</span><span class="p">,</span> <span class="no">DISPATCH_QUEUE_SERIAL</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">queue</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="sr">//</span> <span class="err">包含一個異步方法的</span><span class="no">Method</span>
</span><span class='line'><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">addTaskUploadMovie</span><span class="p">(</span><span class="no">NSDate</span> <span class="o">*</span><span class="p">)</span><span class="n">movie</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">_uploadToParseInBackgroundQueue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s2">&quot;%@上傳Start.......&quot;</span><span class="p">,</span><span class="n">movie</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="sr">//</span> <span class="err">某個很花時間，但本身已經是丟到背景處理的方法</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">self</span> <span class="ss">uploadMovieInBackground</span><span class="p">:</span><span class="n">movie</span> <span class="ss">withCompleteBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="no">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="no">NSError</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="no">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s2">&quot;%@上傳Done&quot;</span><span class="p">,</span><span class="n">movie</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>實際執行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="nb">self</span> <span class="ss">addTaskUploadMovie</span><span class="p">:</span><span class="n">a</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="o">[</span><span class="nb">self</span> <span class="ss">addTaskUploadMovie</span><span class="p">:</span><span class="n">b</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="o">[</span><span class="nb">self</span> <span class="ss">addTaskUploadMovie</span><span class="p">:</span><span class="n">c</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'><span class="o">[</span><span class="nb">self</span> <span class="ss">addTaskUploadMovie</span><span class="p">:</span><span class="n">d</span><span class="o">]</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>這裡有個大問題是<code>uploadMovieInBackground</code>本身已經是跑在背景，所以四個上傳任務實際上在後台是以併發Concurrent/Parallel的方式執行。</p>

<p>而多個高I/0負載任務被同時執行就有可能造成APP崩潰。</p>

<p>實際執行結果會像這樣，但實際上不可預測，因為不能知道哪個會先完成：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span><span class="err">上傳</span><span class="no">Start</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">b</span><span class="err">上傳</span><span class="no">Start</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">a</span><span class="err">上傳</span><span class="no">Done</span>
</span><span class='line'><span class="n">c</span><span class="err">上傳</span><span class="no">Start</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">c</span><span class="err">上傳</span><span class="no">Done</span>
</span><span class='line'><span class="n">d</span><span class="err">上傳</span><span class="no">Start</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">d</span><span class="err">上傳</span><span class="no">Done</span>
</span><span class='line'><span class="n">b</span><span class="err">上傳</span><span class="no">Done</span>
</span></code></pre></td></tr></table></div></figure>


<h2>可控制的完成順序</h2>

<p>而如果你希望上傳程序按照以下Serial的邏輯去跑:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span><span class="err">上傳</span><span class="no">Start</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">a</span><span class="err">上傳</span><span class="no">Done</span>
</span><span class='line'><span class="n">b</span><span class="err">上傳</span><span class="no">Start</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">b</span><span class="err">上傳</span><span class="no">Done</span>
</span><span class='line'><span class="n">c</span><span class="err">上傳</span><span class="no">Start</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">c</span><span class="err">上傳</span><span class="no">Done</span>
</span><span class='line'><span class="n">d</span><span class="err">上傳</span><span class="no">Start</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">d</span><span class="err">上傳</span><span class="no">Done</span>
</span></code></pre></td></tr></table></div></figure>


<h3>加入<code>dispatch_suspend</code>與<code>dispatch_resume</code></h3>

<p>加入這兩個操控Queue的方法就是做兩個目的：</p>

<ul>
<li><p>當某個在Serial Queue的上傳任務Block被執行的時候，此任務在Block內馬上呼叫Queue的Suspend方法，來暫停這個Queue繼續執行下個上傳任務</p></li>
<li><p>而當前上傳任務執行完成之後，在該任務的call back block裡面馬上呼叫Queue的Resume，來讓下個上傳任務被執行</p></li>
</ul>


<p>反覆上述行為就達到我們要的一次在背景做一件事情的效果了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">addTaskUploadMovie</span><span class="p">(</span><span class="no">NSDate</span> <span class="o">*</span><span class="p">)</span><span class="n">movie</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">_uploadToParseInBackgroundQueue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s2">&quot;%@上傳Start.......&quot;</span><span class="p">,</span><span class="n">movie</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="sr">//</span> <span class="err">某個很花時間，但本身已經是丟到背景處理的</span><span class="n">metod</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">self</span> <span class="ss">uploadMovieInBackground</span><span class="p">:</span><span class="n">movie</span> <span class="ss">withCompleteBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="no">BOOL</span> <span class="n">succeeded</span><span class="p">,</span> <span class="no">NSError</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="no">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s2">&quot;%@上傳Done&quot;</span><span class="p">,</span><span class="n">movie</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="sr">//</span> <span class="err">這個</span><span class="no">Task</span><span class="err">執行完了，讓</span><span class="no">Queue</span> <span class="n">resume</span><span class="err">，讓排在下一個的</span><span class="no">Task</span><span class="err">可以被執行</span>
</span><span class='line'>        <span class="n">dispatch_resume</span><span class="p">(</span><span class="n">_uploadToParseInBackgroundQueue</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="sr">//</span> <span class="err">上面的</span><span class="n">uploadMovieInBackground</span><span class="err">開始後，就暫停這個</span><span class="no">Queue</span><span class="err">，不再執行</span><span class="no">Task</span><span class="p">(</span><span class="err">外部依然可以隨時用</span><span class="n">dispatch_async</span> <span class="no">Passing</span> <span class="no">Task</span><span class="p">)</span>
</span><span class='line'>    <span class="n">dispatch_suspend</span><span class="p">(</span><span class="n">_uploadToParseInBackgroundQueue</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW14">dispatch_resume與dispatch_suspend的官方參考文件</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/11/09/objc-quick-sort/">QuickSort與Obj-C</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/07/objc-merge-sort-category-oop/">MergeSort與Obj-C外加Category與OOP</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/24/iap-payment-model-design/">In-App-Purchase交易模組設計</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/11/ios-view-advanced/">從零到穩固的基礎 - 談iOS刻畫UI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/03/ios-fastlane/">運用iOS Fastlane自動化部署TestFlight</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/01/detail-custom-ios-model-animation/">有關製作iOS客製化Animation的詳細過程</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/27/why-to-be-a-cs-engineer/">為什麼要當個CS工程師</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/05/ios-camera-design-pattern-review/">iOS Camera Design Pattern 回顧</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/08/first-presentation-flow/">iOS 實作SlideMenu - 初探ViewController切換</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/04/ios-serial-queue-run-async-background-job/">iOS 大量網路與硬碟I/0處理</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - 施安宏 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mrshih';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
